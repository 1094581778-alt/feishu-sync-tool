# 定时任务功能测试指南

## ✅ 已修复的问题

### 问题：按钮状态显示不正确
**原因**：`scheduledTasks` 从对象改成了数组，但访问方式未更新

**修复前**：
```typescript
scheduledTasks[template.id]?.enabled
```

**修复后**：
```typescript
scheduledTasks.find(t => t.templateId === template.id)?.enabled
```

---

## 🧪 测试步骤

### 1. 测试定时任务配置按钮

1. 打开应用（http://localhost:5000）
2. 在模板列表中找到任意模板
3. 点击模板卡片右上角的 ⚡ 图标
4. 应该打开"新建定时任务"对话框

**预期效果**：
- ✅ 对话框正常打开
- ✅ 显示"基础设置"、"文件筛选"、"文件预览"三个标签页
- ✅ 如果该模板已有任务，按钮变为蓝色（⚡）

---

### 2. 创建定时任务

#### 步骤 1：填写基本信息
- 任务名称：例如"成交数据每日同步"

#### 步骤 2：配置触发时间
**选项 A - 固定时间点**：
- 选择"固定时间点"
- 周期：选择"每天"
- 时间：选择"14:30"

**选项 B - Cron 表达式**：
- 选择"Cron 表达式"
- 输入：`0 30 14 * * *`
- 应该显示绿色提示"✓ Cron 表达式有效"

#### 步骤 3：添加文件路径
- 输入一个本地路径（例如：`C:\Users\YourName\Documents\excel_files`）
- 点击"添加"按钮
- 路径应该显示在下方的列表中

#### 步骤 4：配置文件筛选
- 文件名模式：选择"模糊匹配"
- 文件名模式：输入 `成交数据*`
- 时间筛选：选择"今天"

#### 步骤 5：预览匹配结果
- 切换到"文件预览"标签页
- 应该显示符合筛选条件的文件列表

#### 步骤 6：保存任务
- 点击"保存"按钮
- 应该显示"定时任务已保存"提示

---

### 3. 测试任务管理界面

1. 点击顶部导航栏的 **"定时任务"** 按钮（紫色，⚡图标）
2. 应该打开任务管理对话框

**预期效果**：
```
┌─────────────────────────────────────────┐
│ ⚡ 定时任务管理                          │
├─────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐             │
│ │ 总数 │ │运行中│ │已暂停│             │
│ │  1   │ │  1   │ │  0   │             │
│ └──────┘ └──────┘ └──────┘             │
│                                         │
│ 任务名称 | 触发模式 | 下次执行 | 状态   │
│ ──────────────────────────────────────  │
│ 成交数据 | 每天 14:30| 今天 14:30| ⏰   │
│                            [▶][⏸][✏][📊][🗑]│
└─────────────────────────────────────────┘
```

---

### 4. 测试任务操作

#### 立即执行
1. 在任务列表中找到刚创建的任务
2. 点击 ▶ 按钮（立即执行）
3. 确认执行提示
4. 查看执行结果

**预期**：
- ✅ 显示执行进度
- ✅ 显示处理文件数量
- ✅ 显示同步数据行数
- ✅ 或显示错误信息（如果文件路径不存在）

#### 暂停/启用任务
1. 点击 ⏸ 按钮暂停任务
2. 任务状态变为"已暂停"
3. 再次点击 ▶ 按钮启用任务
4. 任务状态变为"运行中"

#### 查看执行日志
1. 点击 📊 按钮
2. 应该显示执行历史对话框

**预期内容**：
```
┌─────────────────────────────────────────┐
│ 任务执行日志 - 成交数据每日同步          │
├─────────────────────────────────────────┤
│ ✅ 执行成功                    02-28 14:30│
│ 执行完成：处理 3 个文件，同步 120 行数据    │
│ 处理文件：3 个  同步数据：120 行  耗时：5 秒│
│                                         │
│ ❌ 执行失败                    02-28 14:25│
│ 未找到符合条件的文件，任务终止          │
│ 处理文件：0 个  同步数据：0 行            │
└─────────────────────────────────────────┘
```

#### 编辑任务
1. 点击 ✏ 按钮
2. 应该打开配置对话框，显示当前配置
3. 修改任务名称
4. 点击保存
5. 返回任务管理界面，确认名称已更新

#### 删除任务
1. 点击 🗑 按钮
2. 确认删除提示
3. 任务应该从列表中消失

---

### 5. 测试 Cron 表达式验证

#### 有效的 Cron 表达式
输入以下表达式，应该都显示绿色"✓ Cron 表达式有效"：

| Cron 表达式 | 含义 |
|------------|------|
| `0 30 14 * * *` | 每天 14:30 |
| `0 0 9 * * 1-5` | 工作日 9:00 |
| `0 0 10 1 * *` | 每月 1 号 10:00 |
| `0 */30 * * * *` | 每 30 分钟 |
| `0 0 0 * * 0` | 每周日 0:00 |

#### 无效的 Cron 表达式
输入以下表达式，应该显示红色错误提示：

| Cron 表达式 | 错误原因 |
|------------|---------|
| `invalid` | 格式错误 |
| `0 60 14 * * *` | 分钟超出范围 (0-59) |
| `0 0 25 * * *` | 小时超出范围 (0-23) |
| `* * * * *` | 缺少秒字段 |

---

### 6. 测试下次执行时间计算

创建任务后，在任务列表中查看"下次执行"列：

**固定时间点示例**：
- 每天 14:30，当前时间 10:00 → 显示"今天 14:30"
- 每天 14:30，当前时间 15:00 → 显示"明天 14:30"
- 每周一 10:00，当前时间周一 09:00 → 显示"今天 10:00"
- 每周一 10:00，当前时间周一 11:00 → 显示"下周一 10:00"

**Cron 表达式示例**：
- `0 30 14 * * *` → 显示"今天 14:30"或"明天 14:30"
- `0 0 10 1 * *` → 显示"3 月 1 日 10:00"

---

## 🔍 验证要点

### ✅ 界面验证
- [ ] 定时任务配置按钮正常显示
- [ ] 有任务的模板按钮为蓝色，无任务为灰色
- [ ] 点击按钮打开配置对话框
- [ ] 顶部有"定时任务"管理按钮

### ✅ 配置验证
- [ ] 任务名称必填
- [ ] 至少添加一个文件路径
- [ ] Cron 表达式实时验证
- [ ] 保存时自动计算下次执行时间

### ✅ 功能验证
- [ ] 任务保存在 localStorage
- [ ] 刷新页面后任务仍然存在
- [ ] 启用/禁用切换正常
- [ ] 立即执行功能正常
- [ ] 执行日志正常记录

### ✅ 状态验证
- [ ] 任务状态正确显示（成功/失败/运行中）
- [ ] 下次执行时间正确计算
- [ ] 上次运行时间正确更新

---

## 🐛 可能的问题

### 问题 1：文件扫描失败
**原因**：路径不存在或没有权限
**解决**：确保配置的路径真实存在

### 问题 2：Cron 表达式验证失败
**原因**：cron-parser 库导入问题
**解决**：已在 TypeScript 代码中正确导入，不影响使用

### 问题 3：任务不执行
**原因**：应用未运行或页面已关闭
**解决**：保持应用运行，定时任务需要应用在前台或后台运行

### 问题 4：状态不同步
**原因**：localStorage 数据过期
**解决**：清除 localStorage 重新创建任务
```javascript
localStorage.removeItem('scheduled_tasks');
location.reload();
```

---

## 📊 完整测试清单

### 基础功能
- [ ] 打开配置对话框
- [ ] 创建定时任务
- [ ] 保存任务配置
- [ ] 编辑已有任务
- [ ] 删除任务

### 触发模式
- [ ] 固定时间点 - 每天
- [ ] 固定时间点 - 每周
- [ ] 固定时间点 - 每月
- [ ] Cron 表达式
- [ ] Cron 表达式验证

### 文件筛选
- [ ] 文件名精准匹配
- [ ] 文件名模糊匹配
- [ ] 时间筛选 - 今天
- [ ] 时间筛选 - 昨天
- [ ] 时间筛选 - 本周
- [ ] 时间筛选 - 自定义
- [ ] 文件预览

### 任务管理
- [ ] 打开任务管理界面
- [ ] 查看任务列表
- [ ] 查看任务统计
- [ ] 立即执行任务
- [ ] 启用/禁用任务
- [ ] 查看执行日志
- [ ] 编辑任务
- [ ] 删除任务

### 持久化
- [ ] 任务保存到 localStorage
- [ ] 刷新页面保留配置
- [ ] 启用状态保持
- [ ] 执行日志保持

---

## 🎯 测试完成标准

所有测试项都通过后，定时任务功能可以认为是正常工作的！

如果有任何问题，请检查：
1. 浏览器控制台是否有错误
2. localStorage 中是否有 `scheduled_tasks` 数据
3. 应用是否保持运行状态

---

**祝测试顺利！** 🎉
