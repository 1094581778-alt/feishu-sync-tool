# 🧪 定时任务功能 - 快速测试指南

## 📋 测试前准备

### 1. 确认应用正在运行
打开浏览器访问：**http://localhost:5000**

如果没运行，在终端执行：
```bash
pnpm dev --port 5000
```

### 2. 准备测试文件
创建一个测试文件夹，里面放一些 Excel 文件（或任何文件）：
```
C:\Users\你的用户名\Documents\test_files\
├── 成交数据 -2026_02_28.xlsx
├── 订单数据 -2026_02_28.xlsx
└── 测试文件.xlsx
```

---

## 🎯 测试步骤（按顺序）

### ✅ 第一步：创建定时任务

1. **打开应用** → 你应该看到模板列表页面

2. **找到任意模板** → 在模板卡片右上角找到 ⚡ 图标

3. **点击 ⚡ 图标** → 应该弹出"新建定时任务"对话框

   **如果成功**：你会看到三个标签页：基础设置、文件筛选、文件预览

---

### ✅ 第二步：配置任务

#### 2.1 基础设置
在"基础设置"标签页：

1. **任务名称**：输入 `测试任务 - 每日同步`

2. **触发模式**：选择"固定时间点"

3. **周期**：选择"每天"

4. **时间**：选择当前时间的 **2 分钟后**
   - 例如现在是 14:30，就选择 14:32

5. **文件路径**：
   - 输入你准备的测试文件夹路径
   - 例如：`C:\Users\你的用户名\Documents\test_files`
   - 点击"添加"按钮
   - 路径应该显示在下方列表中

---

#### 2.2 文件筛选
切换到"文件筛选"标签页：

1. **文件名匹配**：
   - 模式：选择"模糊匹配"
   - 文件名：输入 `*.xlsx`（匹配所有 Excel 文件）

2. **时间筛选**：
   - 选择"今天"

3. **切换到"文件预览"**：
   - 你应该看到扫描到的文件列表
   - 如果显示"暂无文件"，检查路径是否正确

---

#### 2.3 保存任务

1. 点击右下角 **"保存"** 按钮

2. 应该显示提示："定时任务已保存"

3. 返回模板列表，⚡ 图标应该变成 **蓝色**

---

### ✅ 第三步：查看和管理任务

1. **点击顶部导航栏的"定时任务"按钮**（紫色，⚡图标）

2. 你应该看到任务管理界面：
   ```
   ┌─────────────────────────────────────┐
   │ ⚡ 定时任务管理                      │
   ├─────────────────────────────────────┤
   │ 总数：1    运行中：1    已暂停：0   │
   └─────────────────────────────────────┘
   ```

3. **任务列表应该显示**：
   - 任务名称：测试任务 - 每日同步
   - 触发模式：每天 XX:XX
   - 下次执行：今天 XX:XX（你设置的时间）
   - 状态：⏰ 等待执行

---

### ✅ 第四步：测试立即执行

1. 在任务管理界面，找到你的任务

2. 点击 ▶ 按钮（立即执行）

3. 确认提示："确定要立即执行任务'测试任务 - 每日同步'吗？"

4. **观察执行过程**：
   - 应该显示执行进度
   - 显示处理文件数量
   - 显示同步数据行数

5. **执行完成后**：
   - 状态变为"✅ 成功"或"❌ 失败"
   - 可以看到执行日志

---

### ✅ 第五步：查看执行日志

1. 点击 📊 按钮（查看日志）

2. 你应该看到执行记录：
   ```
   ┌─────────────────────────────────────┐
   │ ✅ 执行成功              02-28 14:32│
   │ 执行完成：处理 3 个文件，同步 120 行数据│
   │ 处理文件：3 个  同步数据：120 行     │
   └─────────────────────────────────────┘
   ```

---

### ✅ 第六步：测试 Cron 表达式

1. 再次点击 ⚡ 图标创建新任务

2. 触发模式选择 **"Cron 表达式"**

3. 输入：`0 */5 * * * *`（每 5 分钟执行一次）

4. **应该显示绿色提示**："✓ Cron 表达式有效"

5. 尝试输入无效表达式：`invalid`

6. **应该显示红色错误**："无效：[错误信息]"

---

### ✅ 第七步：测试暂停/启用

1. 在任务管理界面，点击 ⏸ 按钮

2. 任务状态变为"⏸️ 已暂停"

3. 再次点击 ▶ 按钮

4. 任务状态变回"⏰ 等待执行"

---

### ✅ 第八步：刷新页面验证持久化

1. **刷新浏览器页面**（F5 或 Ctrl+R）

2. 点击顶部"定时任务"按钮

3. **任务应该仍然存在**，说明已保存到 localStorage

---

## 🎉 测试成功标准

完成以上所有步骤后，如果：

- ✅ 能创建定时任务
- ✅ 能配置触发时间
- ✅ 能扫描和筛选文件
- ✅ 能立即执行任务
- ✅ 能查看执行日志
- ✅ 任务配置刷新后还在
- ✅ Cron 表达式验证正常
- ✅ 能暂停/启用任务

**恭喜！定时任务功能完全正常！** 🎊

---

## 🐛 常见问题和解决方法

### 问题 1：点击 ⚡ 没反应
**原因**：可能有 JavaScript 错误
**解决**：
1. 按 F12 打开开发者工具
2. 查看 Console 标签页的错误信息
3. 刷新页面重试

### 问题 2：文件扫描结果为空
**原因**：路径不存在或没有文件
**解决**：
1. 确认路径正确（可以复制粘贴完整路径）
2. 确认路径下有文件
3. 确保文件扩展名匹配筛选条件

### 问题 3：执行失败
**原因**：可能是飞书 API 配置问题
**解决**：
1. 检查飞书配置是否正确
2. 查看执行日志中的错误详情
3. 确保网络连接正常

### 问题 4：任务没有自动执行
**原因**：应用未运行或页面已关闭
**解决**：
1. 保持应用运行（不要关闭浏览器标签页）
2. 定时任务需要应用在前台或后台运行
3. 可以测试"立即执行"功能

### 问题 5：刷新后任务丢失
**原因**：localStorage 被清除
**解决**：
1. 检查浏览器是否清除了 localStorage
2. 重新创建任务
3. 避免使用隐私模式

---

## 📊 快速测试清单

打印这个清单，逐项勾选：

```
□ 1. 应用正常打开（http://localhost:5000）
□ 2. 能看到模板列表
□ 3. 点击 ⚡ 图标打开配置对话框
□ 4. 能填写任务名称
□ 5. 能配置触发时间
□ 6. 能添加文件路径
□ 7. 能看到文件预览
□ 8. 能保存任务
□ 9. ⚡ 图标变成蓝色
□ 10. 能打开任务管理界面
□ 11. 能看到任务列表
□ 12. 能立即执行任务
□ 13. 能查看执行日志
□ 14. 刷新后任务还在
□ 15. 能暂停/启用任务
□ 16. Cron 表达式验证正常
```

**全部勾选 = 测试通过！** ✅

---

## 💡 进阶测试（可选）

### 测试 1：多个任务并发
创建 2-3 个不同的定时任务，观察是否能正常管理

### 测试 2：编辑任务
1. 点击 ✏ 按钮编辑任务
2. 修改任务名称或时间
3. 保存后验证修改生效

### 测试 3：删除任务
1. 点击 🗑 按钮删除任务
2. 确认删除
3. 任务从列表中消失

### 测试 4：不同触发模式
- 每天执行
- 每周执行（选择星期几）
- 每月执行（选择日期）
- Cron 表达式

---

## 📞 需要帮助？

如果测试过程中遇到问题：

1. **查看浏览器控制台**（F12 → Console）
2. **查看网络请求**（F12 → Network）
3. **查看执行日志**（任务管理界面 → 📊）
4. **提供错误信息**，方便定位问题

---

**祝你测试顺利！** 🚀

如果有任何问题，随时告诉我！
