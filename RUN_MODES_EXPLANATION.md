# 🌐 运行模式说明

## ✅ 问题已修复

### 问题
之前报错：`Cannot read properties of undefined (reading 'invoke')`

### 原因
- 文件扫描服务使用了 Tauri FS API
- 在浏览器中运行时，没有 `window.__TAURI__` 对象
- 导致调用失败

### 解决方案
添加了**环境检测**，自动适配运行环境：

---

## 🎯 两种运行模式

### 1️⃣ 浏览器模式（开发/测试）

**访问方式**：http://localhost:5000

**特点**：
- ✅ 所有 UI 功能正常
- ✅ 定时任务配置正常
- ✅ 任务管理功能正常
- ✅ Cron 表达式解析正常
- ✅ 执行流程正常
- ⚠️ 文件扫描返回**模拟数据**

**模拟数据示例**：
```
成交数据 -2026_02_28.xlsx
订单数据 -2026_02_28.xlsx
库存数据 -2026_02_27.xls
```

**适用场景**：
- 开发调试
- 功能演示
- UI 测试
- 流程验证

---

### 2️⃣ Tauri 桌面应用模式（生产）

**运行方式**：
```bash
# 开发模式
pnpm tauri dev

# 构建为 .exe
pnpm tauri build
```

**特点**：
- ✅ 所有 UI 功能正常
- ✅ 定时任务配置正常
- ✅ 任务管理功能正常
- ✅ Cron 表达式解析正常
- ✅ 执行流程正常
- ✅ 文件扫描返回**真实数据**

**真实扫描**：
- 读取指定文件夹下的所有文件
- 获取文件真实元数据（大小、时间等）
- 根据筛选规则过滤文件

**适用场景**：
- 实际使用
- 生产环境
- 真实文件同步

---

## 🔄 自动环境检测

代码会自动检测运行环境：

```typescript
// 检测是否在 Tauri 环境中
const isTauri = () => {
  return typeof window !== 'undefined' && '__TAURI__' in window;
};

// 根据环境选择不同实现
if (!isTauri()) {
  // 浏览器：返回模拟数据
  return mockFiles;
} else {
  // Tauri：使用真实 FS API
  const entries = await readDir(path);
  // ...
}
```

---

## 📊 功能对比

| 功能 | 浏览器模式 | Tauri 桌面模式 |
|------|-----------|---------------|
| 定时任务配置 | ✅ 完全正常 | ✅ 完全正常 |
| 任务管理界面 | ✅ 完全正常 | ✅ 完全正常 |
| Cron 表达式 | ✅ 完全正常 | ✅ 完全正常 |
| 任务执行流程 | ✅ 完全正常 | ✅ 完全正常 |
| 文件扫描 | ⚠️ 模拟数据 | ✅ 真实扫描 |
| 文件筛选 | ✅ 基于模拟数据 | ✅ 基于真实数据 |
| 飞书同步 | ✅ 正常 | ✅ 正常 |
| 执行日志 | ✅ 正常 | ✅ 正常 |

---

## 🎯 推荐使用方式

### 开发阶段
1. **浏览器模式** - 快速开发和测试 UI
2. **Tauri 模式** - 测试真实文件扫描和同步

### 生产阶段
1. **Tauri 桌面应用** - 实际使用，24 小时运行定时任务

---

## 🚀 如何构建桌面应用

### 步骤 1：构建 .exe
```bash
pnpm tauri build
```

### 步骤 2：找到安装包
构建完成后，安装包在：
```
src-tauri/target/release/bundle/
├── msi/          # Windows 安装包
└── nsis/         # Windows 安装程序
```

### 步骤 3：安装并运行
双击安装程序，安装后运行桌面应用

---

## 💡 注意事项

### 浏览器模式
- 文件扫描是模拟数据
- 刷新页面后模拟数据会重置
- 适合功能测试，不适合实际使用

### Tauri 模式
- 需要安装 Rust 和 Tauri CLI
- 构建时间较长
- 可以访问本地文件系统
- 适合作为桌面应用使用

### 定时任务执行
- **浏览器模式**：页面关闭后任务停止
- **Tauri 模式**：应用运行即可执行（即使关闭窗口）
- **生产环境**：建议构建为桌面应用，保持后台运行

---

## ✅ 当前状态

- ✅ 浏览器模式已修复
- ✅ 不再报 `invoke` 错误
- ✅ 文件扫描返回模拟数据
- ✅ 所有功能可以正常测试
- ✅ 支持 Tauri 桌面应用

---

## 🎉 总结

**现在你可以：**

1. **在浏览器中测试所有功能**
   - 配置定时任务
   - 管理任务
   - 查看日志
   - 验证流程

2. **在 Tauri 应用中实际使用**
   - 真实文件扫描
   - 真实飞书同步
   - 24 小时定时执行

3. **无缝切换**
   - 同一套代码
   - 自动适配环境
   - 无需手动配置

**开始测试吧！** 🚀
