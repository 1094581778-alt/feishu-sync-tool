# 字段匹配问题诊断指南

## 问题描述

部署后，字段匹配失败，Excel 字段无法与飞书表格字段匹配。

## 可能的原因

### 1. 字段名称格式差异

**Excel 字段名**: `订单日期`  
**飞书字段名**: `订单日期 ` (末尾有空格)  
**结果**: 无法匹配（精确匹配要求完全一致）

### 2. 字段属性名差异

飞书 API 可能返回：
- `field_name`（旧版本）
- `name`（新版本）
- 两者同时存在但值不同

### 3. 大小写问题

**Excel**: `Product Name`  
**飞书**: `product name`  
**结果**: 无法匹配

### 4. 特殊字符问题

- 不可见字符（空格、制表符等）
- Unicode 字符
- 编码问题

## 调试步骤

### 1. 查看服务器日志

部署后，在上传文件时查看服务器日志：

```bash
# SSH 到服务器
tail -f /app/work/logs/bypass/app.log
```

### 2. 关键日志信息

查找以下日志：

#### A. Excel 字段读取日志

```
📊 [Excel] Sheet: Sheet1
📊 [Excel] 读取到列: ["订单日期", "订单编号", "金额"]
📊 [Excel] 列名详细检查:
  列 1: "订单日期" (长度: 4, 包含空格: false)
  列 2: "订单编号" (长度: 4, 包含空格: false)
  列 3: "金额" (长度: 2, 包含空格: false)
```

#### B. 飞书字段获取日志

```
📋 [飞书字段] 原始字段数据: [...]
🔍 [飞书字段] 字段详情: {
  field_name: "订单日期",
  name: "订单日期",
  type: 5,
  最终使用: "订单日期"
}
📋 [飞书字段] 最终字段名称列表: ["订单日期", "订单编号", "金额"]
```

#### C. 字段匹配分析日志

```
🔍 [字段匹配检查] Excel字段: "订单日期" | 飞书字段: "订单日期" | 匹配: ✅
🔍 [字段匹配检查] Excel字段: "订单编号" | 飞书字段: "订单编号" | 匹配: ✅
🔍 [字段匹配检查] Excel字段: "金额" | 飞书字段: null | 匹配: ❌
```

#### D. 字段匹配分析报告

```
🔍 [字段匹配分析] 开始详细匹配分析
📋 [Excel 列名列表]: ["订单日期", "订单编号", "金额"]
📋 [飞书 字段列表]: ["订单日期", "订单编号", "销售金额"]
📊 [匹配对比]:
✅ [字段匹配] "订单日期" -> 精确匹配成功
✅ [字段匹配] "订单编号" -> 精确匹配成功
❌ [字段匹配] "金额" 未找到匹配的字段
```

### 3. 常见问题诊断

#### 问题 1: 所有字段都匹配失败

**可能原因**:
- 飞书字段 API 返回的字段属性名不是 `field_name`
- 飞书 API 返回空数据

**诊断方法**:
查看日志中的 `📋 [飞书字段] 原始字段数据`，检查：
- 是否有 `field_name` 属性
- 是否有 `name` 属性
- 字段数据格式是否正确

**解决方案**:
修改代码，使用正确的字段属性名。

#### 问题 2: 部分字段匹配失败

**可能原因**:
- 字段名称不完全一致（有空格、大小写差异等）
- Excel 字段名和飞书字段名确实不同

**诊断方法**:
查看日志中的 `📊 [匹配对比]`，找到不匹配的字段，对比：
- Excel 字段名（从 Excel 列名详细检查中获取）
- 飞书字段名（从飞书字段列表中获取）
- 是否有相似字段

**解决方案**:
- 修改 Excel 字段名，使其与飞书字段名完全一致
- 或修改飞书表格字段名
- 或添加字段别名映射

#### 问题 3: 字段匹配成功但数据为空

**可能原因**:
- Excel 数据为空
- 数据类型转换失败

**诊断方法**:
查看日志中的：
- `📊 [Excel] 第一行数据`: 检查 Excel 数据
- `✅ [数据转换] ...`: 检查数据转换结果

## 字段匹配逻辑

### 当前匹配逻辑（精确匹配）

```typescript
const feishuField = fieldNames.find(fn => fn === excelColumn);
```

**要求**: 字段名必须**完全相同**，包括：
- 字符
- 大小写
- 空格
- 特殊字符

### 字段匹配优先级

1. **精确匹配**: `fn === excelColumn`
2. **忽略大小写**: `fn.toLowerCase() === excelColumn.toLowerCase()`
3. **忽略空格**: `fn.trim() === excelColumn.trim()`
4. **包含关系**: `fn.includes(excelColumn) || excelColumn.includes(fn)`

**当前只使用精确匹配**

## 解决方案

### 方案 1: 修改字段名称（推荐）

**步骤**:
1. 查看日志中的飞书字段列表
2. 查看日志中的 Excel 字段列表
3. 修改 Excel 文件的字段名，使其与飞书字段名完全一致
4. 重新上传

### 方案 2: 添加模糊匹配

修改代码，添加更宽松的匹配逻辑：

```typescript
const feishuField = fieldNames.find(fn => {
  // 精确匹配
  if (fn === excelColumn) return true;
  
  // 忽略大小写
  if (fn.toLowerCase() === excelColumn.toLowerCase()) return true;
  
  // 忽略空格
  if (fn.trim() === excelColumn.trim()) return true;
  
  // 包含关系
  if (fn.includes(excelColumn) || excelColumn.includes(fn)) return true;
  
  return false;
});
```

### 方案 3: 字段别名映射

添加字段别名映射配置：

```typescript
const fieldAliases: Record<string, string> = {
  '金额': '销售金额',
  '订单编号': 'order_id',
  // ...
};

const normalizedExcelColumn = fieldAliases[excelColumn] || excelColumn;
const feishuField = fieldNames.find(fn => fn === normalizedExcelColumn);
```

## 日志查看方法

### 本地环境

```bash
# 查看日志
tail -f /app/work/logs/bypass/app.log

# 搜索字段匹配相关日志
grep "字段匹配" /app/work/logs/bypass/app.log

# 搜索飞书字段相关日志
grep "飞书字段" /app/work/logs/bypass/app.log
```

### 外部部署环境

#### 方法 1: 通过部署平台查看

- 登录部署平台
- 找到应用日志
- 搜索关键词：`字段匹配`、`飞书字段`、`Excel`

#### 方法 2: 通过 SSH 访问

```bash
# SSH 到服务器
ssh user@server

# 查看日志
tail -f /app/work/logs/bypass/app.log
```

## 常见错误信息

### 错误 1: 获取字段信息失败

```
获取字段信息失败: 无权限
```

**原因**: 飞书应用没有权限访问该表格

**解决**: 在飞书开放平台添加相应的权限

### 错误 2: 字段名称列表为空

```
📋 [飞书字段] 最终字段名称列表: []
```

**原因**: 
- 表格没有字段
- 字段 API 返回数据格式错误

**解决**: 
- 检查表格是否有字段
- 查看原始字段数据日志

### 错误 3: 所有字段未匹配

```
📊 [匹配对比]:
❌ [字段匹配] "订单日期" 未找到匹配的字段
❌ [字段匹配] "订单编号" 未找到匹配的字段
```

**原因**: 
- 飞书字段名获取失败
- 字段属性名错误

**解决**: 
- 查看原始字段数据日志
- 修改字段属性获取逻辑

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 飞书表格字段列表（截图或文本）
2. Excel 文件字段列表（截图或文本）
3. 服务器日志（包含 `字段匹配`、`飞书字段`、`Excel` 的日志）
4. 部署环境信息（本地/外部部署）
5. Excel 文件示例（脱敏后）
